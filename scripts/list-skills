#!/usr/bin/env -S uv run -s
# /// script
# requires-python = ">=3.8"
# dependencies = ["python-frontmatter","pyyaml"]
# ///
import os, sys, json
from pathlib import Path
import frontmatter

root = (
    Path(sys.argv[1])
    if len(sys.argv) > 1
    else Path(
        os.environ.get("CODEX_SKILLS_DIR", str(Path.home() / ".config/codex/skills"))
    )
)
if not root.exists():
    print(f"missing skills dir: {root}", file=sys.stderr)
    sys.exit(1)

skills = []
for f in sorted(root.rglob("SKILL.md")):
    meta = (frontmatter.load(f).metadata) or {}
    n, d = meta.get("name"), meta.get("description")
    if isinstance(n, str) and isinstance(d, str):
        item = {"name": n, "description": d, "path": str(f)}
        if "allowed-tools" in meta:
            item["allowed-tools"] = meta["allowed-tools"]
        skills.append(item)
skills.sort(key=lambda s: s["name"])
json.dump(skills, sys.stdout, ensure_ascii=False, indent=2)