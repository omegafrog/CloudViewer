

# Step 3 산출물 종료 문서

**API 명세 & 에러/인증 최소 설계 (v1)**

---

## 1. 단계 개요

### 단계명

**Step 3 – API 명세 & 에러/인증 최소 설계**

### 목적

Unified Storage Backend v1(Read-only)의

* 외부에 노출되는 REST API 계약을 확정하고
* pagination/cursor, 에러 모델, 인증 방식을 포함한
  **“API 소비자가 의존할 수 있는 안정된 인터페이스”**를 정의한다.

본 단계는 **구현 이전에 API Contract를 고정**하기 위한 단계이며,
이후 단계(Step 4 이후)에서는 **본 문서 내용을 변경하지 않는다**.

---

## 2. 적용된 공식 전제

본 단계는 아래 확정 문서를 **변경 없이 전제**로 삼는다.

* Step 0 – 문제 정의 & 목표 합의
* Step 1 – 요구사항 수집 & 구조화 (FRD/NFRD v1)
* Step 2 – 도메인 모델링 & 핵심 흐름 (Provider / Node / node_id / NAS Index)

특히 다음 원칙을 엄격히 유지하였다:

* v1은 **Read-only**
* Provider 루트 병합 없음
* node_id는 전역 유니크 · 불변
* NAS는 OS 직접 조회가 아닌 **Index DB 기반**
* Provider 장애는 전체 장애로 전파되지 않음

---

## 3. Step 3에서 확정된 주요 결정 사항

### 3.1 API 리소스 구조 확정

외부 API는 다음 리소스 단위로 구성된다.

* **Providers**: 스토리지 연결 단위 (관리/상태)
* **Roots**: 탐색 시작점(provider_key 루트)
* **Nodes**: 파일/폴더의 통합 논리 객체
* **Download**: node_id 기반 다운로드
* **NAS Index (운영)**: NAS 인덱스 상태/재구축

Provider 네임스페이스는 병합되지 않으며,
모든 탐색은 **단일 Provider 범위**에서 이루어진다.

---

### 3.2 REST API 엔드포인트 확정

v1 API는 다음 범주로 확정되었다.

* Provider 관리

  * 등록 / 조회 / 수정 / 삭제
  * health 상태 조회
* 탐색

  * provider_key 기반 디렉토리 목록
  * node_id 기반 단건 조회
* 다운로드

  * node_id 기반 파일 다운로드
* NAS Index 운영

  * 인덱스 상태 조회
  * 인덱스 재구축 트리거(운영용)

👉 **새로운 외부 API 추가는 Step 3 이후 금지**

---

### 3.3 Pagination / Cursor 설계 확정

Pagination은 **offset 기반이 아닌 cursor 기반**으로 확정되었다.

#### Cursor 핵심 원칙

* cursor는 **서버가 생성**
* 클라이언트는 **opaque string으로 저장/전달만 수행**
* cursor 내부에는:

  * provider_key
  * 탐색 scope(path 또는 parent_node_id)
  * 정렬 기준(last item)
  * 생성 시각
* TTL = **10분**
* 만료 시 `CURSOR_EXPIRED` + HTTP 410(Gone)

#### 보안 정책

* cursor는 **서명 또는 암호화 필수**
* 클라이언트 생성/변조 불가
* 서버만 검증/복호화

---

### 3.4 정렬 규칙 고정

목록 조회의 정렬은 v1에서 **변경 불가**로 고정되었다.

1. kind: `FOLDER` → `FILE`
2. name: 오름차순(case-insensitive)
3. node_id: tie-breaker

이 정렬 기준은:

* cursor 생성
* NAS Index 조회
* Cloud Connector pagination 변환
  모두에 동일하게 적용된다.

---

### 3.5 에러 모델 및 에러 코드 확정

모든 에러 응답은 **단일 표준 포맷**을 따른다.

* `error.code`: **enum으로 고정**
* `error.message`: 사람 읽기용 메시지
* `error.details`: 선택적 구조 정보
* `meta.trace_id`: 필수

Provider/Connector 에러는 표준 에러 코드로 매핑되며,
HTTP status와 error.code는 **의미적으로 일관되게 사용**한다.

---

### 3.6 Provider 장애 및 부분 실패 정책 확정

* Provider 장애는 **요청 단위 실패**로 처리
* 단일 Provider 요청:

  * DOWN → 503
  * TIMEOUT → 504
* Provider 목록/Roots 조회:

  * 일부 Provider 실패가 있어도 **200 유지**
  * 각 Provider 상태로 표현

멀티-provider 조회 API는 v1에서 제공하지 않으며,
미래 확장을 위한 설계 메모만 `x-future`로 남겼다.

---

### 3.7 인증 / 인가 v1 최소 설계 확정

* 인증 방식: `Authorization: Bearer <token>`
* v1은 단일 테넌트 전제
* 기본 정책: **인증된 요청은 허용**

권장 운영 방식:

* DATA_TOKEN: 조회/다운로드
* ADMIN_TOKEN: Provider/Index 관리

권한 스코프는 선택 사항으로 정의되었으며,
v1 필수 요구사항은 아니다.

---

## 4. Step 3에서 의도적으로 제외한 항목

다음 항목은 **의도적으로 설계 대상에서 제외**되었다.

* 이전 페이지 이동
* Range(부분) 다운로드
* 멀티-provider 검색
* Write / Sync / Upload
* UI/UX
* 멀티 테넌트

이는 Step 0~1에서 확정된 **v1 범위 제한**을 준수한 결과다.

---

## 5. 산출물 목록 (Step 3 완료 기준)

Step 3 종료 시점에 다음 산출물이 확정되었다.

1. **REST API Endpoint 정의 문서**
2. **요청/응답 JSON 스키마**
3. **Pagination / Cursor 규칙 문서**
4. **Error Model & Error Code 표**
5. **Authentication / Authorization v1 설계**
6. **OpenAPI 3.0.3 Spec (v1 draft, full)**

위 산출물은 **Step 4 이후 단계의 변경 대상이 아니다**.

---

## 6. Step 3 종료 선언

본 문서는 **Unified Storage Backend v1**의
외부 API 계약을 확정하는 **Step 3 종료 문서**이다.

* Step 3의 목표는 달성되었다.
* API/에러/커서/인증 설계는 **동결(freeze)** 상태로 전환된다.
* 이후 단계는 **본 계약을 소비하는 내부 설계/구현 단계**로 진행한다.

---

## 7. 다음 단계 안내

다음 단계는 다음 중 하나로 진행한다.

* **Step 4 – Storage Connector 인터페이스 & 내부 구현 설계**
* NAS Provider 기준 PoC 구현

Step 4에서는 **외부 API를 변경하지 않고**,
Connector/Indexer/Core 내부 구조만을 설계한다.

---
