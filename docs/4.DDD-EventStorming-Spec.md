# DDD / Event Storming 최종 산출물 스펙 (Step 1~9)

본 문서는 이벤트 스토밍 최종 산출물(1~9단계) 기반으로 **Bounded Context 경계**, **의존성 분리**, **실패/변경 전파 규칙**을 유지하면서 구현 가능한 **컴포넌트 분리 및 클래스/메서드 시그니처**를 정의한다.

---

## 1) 모듈 구성 및 의존성 분리

### 모듈 구조

```
modules/
  api/                # 플러그인과 코어 사이의 공통 인터페이스
  core/               # Repository/File/Indexing 구현
  plugin-runtime/     # 플러그인 로더 및 레지스트리
  plugins/            # 실제 플러그인 JAR 배포(외부)
```

### 의존 방향

```
plugins (jar) ──> api
core ──────────> api
plugin-runtime ─> api
core ──────────> plugin-runtime
```

- **Plugin은 core에 직접 의존하지 않는다.**
- **core는 plugin 구현체에 직접 의존하지 않는다.**
- **api 모듈**을 통해서만 상호 의존이 발생한다.

---

## 2) Bounded Context별 컴포넌트 분리

### Plugin BC

- **역할**: Repository 유형에 따른 파일 접근 wrapper 제공
- **원칙**: 판정 결과 인터페이스만 외부 제공, 내부 상태 노출 금지

**컴포넌트**

- `RepositoryPlugin` (api)
- `PluginAvailability` (api)
- `PluginRegistry` (plugin-runtime)
- `PluginLoader` (plugin-runtime)

### Repository BC

- **역할**: 저장소 사용 가능성 판정 및 작업 전제 확인
- **원칙**: Plugin 판정 결과만 사용

**컴포넌트**

- `RepositoryService` (core)
- `RepositoryAggregate` (core)
- `RepositoryHandle` (api)

### File BC

- **역할**: 저장소 단위 파일 식별 유효성 보장
- **원칙**: Repository 불능 시 File 수행 전면 불가

**컴포넌트**

- `FileService` (core)
- `FileAggregate` (core)
- `FileHandle` (api)

### Indexing BC

- **역할**: 인덱스 ↔ 저장소 정합성 관리
- **원칙**: Repository/File 상태를 전제하지 않음, Repository 불능 시 보류

**컴포넌트**

- `IndexingService` (core)

---

## 3) API 모듈 스펙 (core ↔ plugin 경계)

### 3.1 Plugin API

```java
package api.plugin;

public interface RepositoryPlugin {
    String pluginId();
    String repositoryType(); // e.g. "NAS", "GDRIVE", ...
    PluginAvailability availability(RepositoryDescriptor repo);
    RepositoryConnector connector(RepositoryDescriptor repo);
}

public final class PluginAvailability {
    public enum Status { AVAILABLE, UNAVAILABLE }
    private final Status status;
    private final String reasonCode; // optional
    private final String message;    // optional
    // getters
}
```

**역할**

- `RepositoryPlugin`: 플러그인 엔트리 포인트. repository 타입별 접근 래핑 제공.
- `availability`: Repository BC가 “현재 판정 결과”만 요구할 수 있는 표준 판정 결과 반환.

### 3.2 Repository / File API

```java
package api.repository;

public interface RepositoryConnector {
    RepositoryHandle open(RepositoryDescriptor repo);
}

public interface RepositoryHandle {
    FileHandle fileHandle();
    RepositoryMeta meta();
}

public interface FileHandle {
    FileNode get(NodeId id);
    List<FileNode> list(Path path, PageRequest page);
    DownloadStream download(NodeId id);
}
```

**역할**

- `RepositoryConnector`: 플러그인이 제공하는 저장소 접근 래퍼.
- `RepositoryHandle`: 저장소 연결 단위.
- `FileHandle`: 파일 접근 기능(읽기 전용).

### 3.3 공통 DTO

```java
package api.common;

public record RepositoryDescriptor(String repositoryId, String type, Map<String, String> config) {}
public record RepositoryMeta(String repositoryId, String type, String status) {}

public record NodeId(String value) {}
public record FileNode(NodeId id, String path, String name, boolean isFile, Map<String, String> metadata) {}

public record PageRequest(String cursor, int limit) {}
public record DownloadStream(InputStream stream, String contentType, long length) {}
```

---

## 4) Core 모듈 스펙 (Repository / File / Indexing)

### 4.1 Repository BC

```java
package core.repository;

public class RepositoryService {
    private final PluginRegistry pluginRegistry;

    public RepositoryService(PluginRegistry pluginRegistry) { ... }

    public RepositoryHandle openRepository(RepositoryDescriptor descriptor);
    public RepositoryAvailability checkAvailability(RepositoryDescriptor descriptor);
}
```

**역할**

- `openRepository`: 매 작업마다 Plugin의 현재 판정 결과를 확인하고 전제 위반 시 실패.
- `checkAvailability`: Plugin 판정 결과만 노출.

### 4.2 File BC

```java
package core.file;

public class FileService {
    private final RepositoryService repositoryService;

    public FileNode getFile(RepositoryDescriptor repo, NodeId id);
    public List<FileNode> listFiles(RepositoryDescriptor repo, Path path, PageRequest page);
    public DownloadStream download(RepositoryDescriptor repo, NodeId id);
}
```

**역할**

- Repository 불능 시 File 작업 전면 실패.
- 파일 유효성 불변은 생성/조작 시점에만 검증 (v1 read-only에서는 확장 포인트).

### 4.3 Indexing BC

```java
package core.indexing;

public class IndexingService {
    public void scheduleSync(RepositoryDescriptor repo);
    public IndexStatus status(RepositoryDescriptor repo);
}
```

**역할**

- Repository 불능 시 인덱싱 보류.
- File/Repository 내부 불변을 전제하지 않음.

---

## 5) Plugin Runtime (JAR 로딩)

### 5.1 Plugin Loader

```java
package plugin.runtime;

public class PluginLoader {
    public RepositoryPlugin load(Path jarPath);
}
```

**역할**

- JAR에서 `RepositoryPlugin` 구현체를 로딩.

### 5.2 Plugin Registry

```java
package plugin.runtime;

public class PluginRegistry {
    public void register(RepositoryPlugin plugin);
    public Optional<RepositoryPlugin> findByType(String repositoryType);
}
```

**역할**

- repositoryType 기준으로 플러그인 검색.
- core는 `PluginRegistry`를 통해서만 plugin 접근.

### 5.3 JAR 엔트리 규칙 (권장)

- `META-INF/services/api.plugin.RepositoryPlugin` 사용
- ServiceLoader 기반 로딩

```java
ServiceLoader<RepositoryPlugin> loader = ServiceLoader.load(RepositoryPlugin.class, jarClassLoader);
```

---

## 6) BC 의존/실패/변경 전파 정합성

### Plugin → Repository

- Repository는 Plugin의 판정 결과 인터페이스만 사용
- Plugin 실패 → Repository 전제 위반(불능)
- 기준 변경은 실패와 구분됨

### Repository → File

- Repository 불능 → File 전면 불능
- File 불변은 불능 상태에서도 깨지지 않음

### File ↔ Indexing

- 완전 단절 (의존/실패/변경 전파 없음)

---

## 7) 요약

- Plugin은 repository 타입에 따른 **파일 접근 wrapper** 역할만 수행한다.
- core는 **api 모듈 경계**를 통해 Plugin을 간접 사용한다.
- Plugin은 **JAR 로딩**으로 외부에서 추가 가능하다.
- BC 경계/실패/변경 전파 정의와 **모순 없음**.
